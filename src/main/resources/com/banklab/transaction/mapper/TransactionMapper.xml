<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.banklab.transaction.mapper.TransactionMapper">

    <select id="getMonthlySummary" resultType="com.banklab.transaction.dto.MonthlySummaryDTO">
        SELECT
            #{startDate} AS startDate,
            #{endDate} AS endDate,
            IFNULL(SUM(CASE WHEN resAccountIn > 0 THEN resAccountIn ELSE 0 END), 0) AS totalIncome,
            IFNULL(SUM(CASE WHEN resAccountOut > 0 THEN resAccountOut ELSE 0 END), 0) AS totalExpense
        FROM transaction_history
        WHERE transaction_date BETWEEN #{startDate} AND #{endDate}
          AND resAccount = #{resAccount}
    </select>

    <select id="getDailyExpense" resultType="com.banklab.transaction.dto.DailyExpenseDTO">
        <![CDATA[
        WITH RECURSIVE dates AS (
            SELECT #{startDate} AS date
            UNION ALL
            SELECT DATE_ADD(date, INTERVAL 1 DAY)
            FROM dates
            WHERE date < #{endDate}
        )

        SELECT
            d.date,
            DATE_FORMAT(d.date, '%Y-%m') AS yearMonth,  -- ← 월 정보 추가
            IFNULL(SUM(CASE WHEN th.resAccountOut > 0 THEN th.resAccountOut ELSE 0 END), 0) AS totalExpense
        FROM
            dates d
                LEFT JOIN
            transaction_history th
            ON th.transaction_date = d.date
                AND th.resAccount = #{resAccount}
        GROUP BY
            d.date
        ORDER BY
            d.date
        ]]>
    </select>

    <select id="getExpensesByCategory" resultType="com.banklab.category.dto.CategoryExpenseDTO">
        SELECT
            c.id AS categoryId,
            c.name AS categoryName,
            SUM(t.resAccountout) AS totalExpense
        FROM transaction_history t
                 JOIN category c ON t.category_id = c.id
        WHERE t.resAccountOut > 0 -- 지출만
          AND t.transaction_date BETWEEN #{startDate} AND #{endDate}
        GROUP BY c.id, c.name
        ORDER BY totalExpense DESC
    </select>
</mapper>
