<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">



<mapper namespace="com.banklab.peerCompare.mapper.ComparisonMapper">
    <select id="getPeerCategoryExpense" resultType="com.banklab.peerCompare.dto.CategoryComparisonDTO">
        SELECT
            c.id AS categoryId,
            c.name AS categoryName,
            IFNULL(AVG(s.total_expense), 0) AS avgExpense
        FROM daily_user_expense_summary s
                 JOIN category c ON s.category_id = c.id
                 JOIN member_with_age m ON s.member_id = m.member_id
        WHERE s.date BETWEEN #{startDate} AND #{endDate}
          AND m.age BETWEEN #{ageFrom} AND #{ageTo}
          AND s.member_id != #{memberId}
        GROUP BY c.id, c.name
    </select>

    <select id="getPeerTotalAvgExpense" resultType="java.lang.Long">
        SELECT IFNULL(AVG(total), 0)
        FROM (
                 SELECT SUM(s.total_expense) AS total
                 FROM daily_user_expense_summary s
                          JOIN member_with_age m ON s.member_id = m.member_id
                 WHERE s.date BETWEEN #{startDate} AND #{endDate}
                   AND m.age BETWEEN #{ageFrom} AND #{ageTo}
                   AND s.member_id != #{memberId}
                 GROUP BY s.member_id
             ) AS peer_totals
    </select>

</mapper>