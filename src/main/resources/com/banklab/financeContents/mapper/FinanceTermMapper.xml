<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.banklab.financeContents.mapper.FinanceTermMapper">

    <!-- 결과 매핑 -->
    <resultMap id="FinanceTermResultMap" type="com.banklab.financeContents.domain.FinanceTermVO">
        <result property="id" column="id"/>
        <result property="keyword" column="keyword"/>
        <result property="title" column="title"/>
        <result property="definition" column="definition"/>
    </resultMap>

    <!-- 기본 컬럼 -->
    <sql id="baseColumns">
        id, keyword, title, definition
    </sql>

    <!-- 모든 금융용어 조회 -->
    <select id="selectAllTerms" resultMap="FinanceTermResultMap">
        SELECT <include refid="baseColumns"/>
        FROM finance_terms
        ORDER BY title ASC
    </select>

    <!-- 금융용어 개수 조회 -->
    <select id="selectTermsCount" resultType="int">
        SELECT COUNT(*)
        FROM finance_terms
    </select>

    <!-- 용어로 검색 (부분 일치) - keyword와 title에서만 검색 -->
    <select id="searchByTerm" resultMap="FinanceTermResultMap">
        SELECT <include refid="baseColumns"/>
        FROM finance_terms
        WHERE keyword LIKE CONCAT('%', #{term}, '%')
           OR title LIKE CONCAT('%', #{term}, '%')
        ORDER BY 
            CASE WHEN keyword = #{term} THEN 1 
                 WHEN title = #{term} THEN 2 
                 ELSE 3 END,
            CASE WHEN keyword LIKE CONCAT(#{term}, '%') THEN 1 
                 WHEN title LIKE CONCAT(#{term}, '%') THEN 2 
                 ELSE 3 END,
            title ASC
    </select>

    <!-- 주제로 검색 (키워드와 제목에서만 검색) -->
    <select id="searchBySubject" resultMap="FinanceTermResultMap">
        SELECT <include refid="baseColumns"/>
        FROM finance_terms
        WHERE keyword LIKE CONCAT('%', #{subject}, '%')
           OR title LIKE CONCAT('%', #{subject}, '%')
        ORDER BY title ASC
    </select>

    <!-- 정확한 용어로 조회 -->
    <select id="selectByExactTerm" resultMap="FinanceTermResultMap">
        SELECT <include refid="baseColumns"/>
        FROM finance_terms
        WHERE keyword = #{term} OR title = #{term}
        LIMIT 1
    </select>

    <!-- 키워드로 정확한 조회 -->
    <select id="selectByKeyword" resultMap="FinanceTermResultMap">
        SELECT <include refid="baseColumns"/>
        FROM finance_terms
        WHERE keyword = #{keyword}
        LIMIT 1
    </select>

    <!-- 페이징 처리된 용어 조회 -->
    <select id="selectTermsWithPaging" resultMap="FinanceTermResultMap">
        SELECT <include refid="baseColumns"/>
        FROM finance_terms
        ORDER BY title ASC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- ID로 금융용어 조회 -->
    <select id="selectById" resultMap="FinanceTermResultMap">
        SELECT <include refid="baseColumns"/>
        FROM finance_terms
        WHERE id = #{id}
    </select>

    <!-- 금융용어 삽입 -->
    <insert id="insertTerm" parameterType="com.banklab.financeContents.domain.FinanceTermVO"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO finance_terms (
            keyword, title, definition
        ) VALUES (
            #{keyword}, #{title}, #{definition}
        )
    </insert>

    <!-- 금융용어 업데이트 -->
    <update id="updateTerm" parameterType="com.banklab.financeContents.domain.FinanceTermVO">
        UPDATE finance_terms
        SET keyword = #{keyword},
            title = #{title},
            definition = #{definition}
        WHERE id = #{id}
    </update>

    <!-- 금융용어 삭제 -->
    <delete id="deleteTerm">
        DELETE FROM finance_terms
        WHERE id = #{id}
    </delete>

    <!-- 전체 데이터 삭제 -->
    <delete id="deleteAllTerms">
        DELETE FROM finance_terms
    </delete>

    <!-- 배치 삽입 -->
    <insert id="insertTermsBatch" parameterType="list">
        INSERT INTO finance_terms (keyword, title, definition)
        VALUES
        <foreach collection="terms" item="term" separator=",">
            (#{term.keyword}, #{term.title}, #{term.definition})
        </foreach>
    </insert>

</mapper>
