<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.banklab.account.mapper.AccountMapper">

    <resultMap id="AccountMap" type="com.banklab.account.domain.AccountVO">
        <id property="id" column="id"/>
        <result property="memberId" column="member_id"/>
        <result property="connectedId" column="connected_id"/>
        <result property="organization" column="organization"/>
        <result property="resAccountName" column="resAccountName"/>
        <result property="resAccount" column="resAccount"/>
        <result property="resAccountDisplay" column="resAccountDisplay"/>
        <result property="resAccountBalance" column="resAccountBalance"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 계좌 정보 저장 -->
    <insert id="insertAccount" parameterType="com.banklab.account.domain.AccountVO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO account (
            member_id,
            connected_id,
            organization,
            resAccountName,
            resAccount,
            resAccountDisplay,
            resAccountBalance,
            created_at
        ) VALUES (
                     #{memberId},
                     #{connectedId},
                     #{organization},
                     #{resAccountName},
                     #{resAccount},
                     #{resAccountDisplay},
                     #{resAccountBalance},
                     NOW()
                 )
    </insert>

    <!-- 유저 아이디로 계좌 목록 조회 -->
    <select id="selectAccountsByUserId" parameterType="Long" resultMap="AccountMap">
        SELECT *
        FROM account
        WHERE member_id = #{memberId}
        ORDER BY created_at DESC
    </select>

    <!-- 계좌 연결 해제-->
    <delete id="deleteAccount">
        DELETE FROM account
        WHERE member_id = #{memberId}
          AND connected_id = #{connectedId}
    </delete>

    <!-- 잔액만 업데이트 - 새로고침용 -->
    <update id="updateAccountBalance">
        UPDATE account
        SET resAccountBalance = #{newBalance}
        WHERE member_id = #{memberId}
          AND resAccount = #{resAccount}
    </update>


    <!-- 계좌 ID와 회원 ID로 계좌 정보 조회 (소유권 검증) -->
    <select id="selectAccountByIdAndMemberId" resultMap="AccountMap">
        SELECT *
        FROM account
        WHERE id = #{accountId}
          AND member_id = #{memberId}
    </select>

    <!-- 계좌 ID로 실제 계좌번호 조회 -->
    <select id="getResAccountById" resultType="String">
        SELECT resAccount
        FROM account
        WHERE id = #{accountId}
          AND member_id = #{memberId}
    </select>

</mapper>